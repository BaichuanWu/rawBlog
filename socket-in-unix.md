---
title: socket_in_unix
date: 2016-08-19 15:29:49
categories: programming
tags: tips
---

### SOCKET

#### 0.TCP/IP基础

0.1 OSI参考模型和OSI协议

<!--more-->

> 网络连接
>
> - 传输速率：即带宽
> - 吞吐量：在传输速率基础上，同时衡量主机CPU,网络拥堵，存储设备存储能力。
> - MTU最大传输单元
>
> 网络设备
>
> - 网卡：是计算机联网的设备
> - 中继器：OSI模型物理层面——调整放大波形，延长网络，可连接不同媒介或相同媒介，不能在传输速度不同媒介间转换，不能改变传输速度，即使数据链路层出现错误仍然转发
> - 网桥:OSI模型数据链路层面——根据数据帧内容转发，根据物理地址进行处理
> - 路由器：OSI模型网络层面——根据IP地址进行处理
> - 4~7层交换机：负载均衡器（DNS也可以）
> - 网关：协议的转换和数据的转发，在同一类型的协议之间转发数据叫做应用网关（代理：客户端和服务端无需在网络层直接通信，而从传输层到应用层对数据访问进行控制）
>
> 连接互联网的所有主机和路由器必须实现IP的功能，网桥，中继器，集线器则不用
>
> ![网络设备](https://github.com/BaichuanWu/prictures/raw/master/socket_info/0_1.png)
>
> 网络层：
>
> IP：IP是跨越网络传送数据包，其也隐藏数据链路层功能，使相互通讯的主机不管经过什么样的底层数据链路都能通讯。也是分组交换协议，但没有重发机制，非可靠性传输协议。
>
> ICMP:数据包异常未到达对端，需要给发送端发送一个异常通知。可以诊断网络状况
>
> ARP:从分组包的IP地址中解析出物理地址的协议。
>
> WWW中http属于应用层，html属于表示层
>
> FTP会建立两个TCP连接，分别是传送请求需要的控制链接和实际传输数据的数据连接
>
> 表述数据的单位：
>
> - 帧：表示数据链路层中包的单位
> - 数据报：IP和UDP等网络层以上分层中包的单位
> - 段：TCP数据流的信息
> - 消息：应用协议中数据单位
>
> MAC地址长48位
>
> **IP info:**
>
> - 数据链路层主要作用是在互连同一种数据链路的节点之间进行包传递。若需要跨越多种数据链路需要借助网络层
> - IP是实现多个链路之间通信的协议。
> - IP是无连接的
> - IPv4 4.3billion
>
> 路由控制表
>
> - 默认路由0.0.0.0/0 活default
> - 主机路由 IP地址/default
> - 环回地址 127.0.0.1 或localhost
>
> TCP:
>
> - MSS:最大分段大小
>
>
> - 窗口大小：无需等待确认应答而可发送数据的最大值（段）

#### 1. 介绍

##### 1.1 在典型客户端服务端场景中，应用程序使用socket通讯方式如下

- 各应用程序创建一个socket,socket是一个允许通讯的设备。
- 服务端将socket 绑定到一个众所周知的地址，是客户端能够定位。

**socket 存在一个通信demain中，domain确定：**

- 识别出一个socket的方法（即socket地址格式）
- 通讯范围（同一主机还是不同）

主要有以下demain,AF(表示address family)，PF(表示protocal family)

![socket_demian](https://github.com/BaichuanWu/prictures/raw/master/socket_info/domian.png)

##### **1.2 socket类型**：每个socket实现都至少提供了两种socket：流和数据报

**流socket（SOCK_STREAM）(面向连接)提供了一个可靠地双相字节通信通道：**

- 可靠：保证发送者传输的数据会完整无缺的到达或收到失败通知
- 双向：数据可以在两个socket任意传输
- 字节流：不存在消息边界（同unix管道）

> 保护消息边界，就是指传输协议把数据当作一条独立的消息在网上传输,接收端只能接收独立的消息.也就是说存在保护消息边界,接收 端一次只能接收发送端发出的一个数据包。
>
> 而面向流则是指无保护**消息保护边界**的,如果发送端连续发送数据, 接收端有可能在一次接收动作中,会接收两个或者更多的数据包。
>
> example：连续发送三个数据包,大小分别是2k, 4k , 8k,这三个数据包,都已经到达了接收端的网络堆栈中,如果使用**UDP**协议,不管我们使用多大的接收缓冲区去接收数据,我们必须有三次接收动作,才能够把所有的数据包接收完.而使用TCP协议,我们只要把接收的缓冲区大小设置在14k以上,我们就能够一次把所有的数据包接收下来.只需要有一次接收动作。

**数据报socket（SOCK_DGRAM）**:

- 不可靠：消息到达可能重复，乱序，未到达
- 面向消息
- 无连接

> 文件描述符在形式上是一个非负整数。实际上，它是一个索引值，指向[内核](https://zh.wikipedia.org/wiki/%E5%86%85%E6%A0%B8)为每一个[进程](https://zh.wikipedia.org/wiki/%E8%BF%9B%E7%A8%8B)所维护的该进程打开文件的记录表。当程序打开一个现有文件或者创建一个新文件时，内核向进程返回一个文件描述符。在[程序设计](https://zh.wikipedia.org/wiki/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1)中，一些涉及底层的程序编写往往会围绕着文件描述符展开。但是文件描述符这一概念往往只适用于[UNIX](https://zh.wikipedia.org/wiki/UNIX)、[Linux](https://zh.wikipedia.org/wiki/Linux)这样的操作系统。

**1.3 流socket**

接受连接:accept()

```c
#include <sys/socket.h>

int accept(int sockfd, struct sockaddr *addr, socklen_t *addrlen)
//accept 会创建一个新的socket, 这个新的socket 会与对等（客户端执行connet()）的socket 进行连接，并返回新的socket文件描述符
```